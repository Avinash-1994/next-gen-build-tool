import { Plus, Search } from 'lucide-react'
import { useState } from 'react'
import { usePipelineStore } from '../../../stores/pipelineStore'

const nodeTemplates = [
    {
        type: 'resolver',
        label: 'Resolver',
        description: 'Resolve module paths and dependencies',
        icon: 'ðŸ”',
        category: 'Input',
    },
    {
        type: 'transformer',
        label: 'Transformer',
        description: 'Transform and transpile source code',
        icon: 'âš™ï¸',
        category: 'Transform',
    },
    {
        type: 'bundler',
        label: 'Bundler',
        description: 'Bundle modules together',
        icon: 'ðŸ“¦',
        category: 'Build',
    },
    {
        type: 'optimizer',
        label: 'Optimizer',
        description: 'Optimize and minify output',
        icon: 'âš¡',
        category: 'Optimize',
    },
    {
        type: 'plugin',
        label: 'Plugin Manager',
        description: 'Manage build plugins',
        icon: 'ðŸ”Œ',
        category: 'Extension',
    },
    {
        type: 'microfrontend',
        label: 'Micro Frontend',
        description: 'Setup micro-frontend architecture',
        icon: 'ðŸ§©',
        category: 'Architecture',
    },
    {
        type: 'ai',
        label: 'AI Assistant',
        description: 'AI-powered build optimization',
        icon: 'ðŸ¤–',
        category: 'AI',
    },
]

export default function NodeLibrary() {
    const [searchTerm, setSearchTerm] = useState('')
    const [selectedCategory, setSelectedCategory] = useState('All')
    const { addNode } = usePipelineStore()

    const categories = ['All', ...new Set(nodeTemplates.map((n) => n.category))]

    const filteredTemplates = nodeTemplates.filter((template) => {
        const matchesSearch =
            template.label.toLowerCase().includes(searchTerm.toLowerCase()) ||
            template.description.toLowerCase().includes(searchTerm.toLowerCase())
        const matchesCategory = selectedCategory === 'All' || template.category === selectedCategory
        return matchesSearch && matchesCategory
    })

    const handleDragStart = (event, template) => {
        event.dataTransfer.setData('application/reactflow', JSON.stringify(template))
        event.dataTransfer.effectAllowed = 'move'
    }

    const handleAddNode = (template) => {
        const newNode = {
            id: `${template.type}_${Date.now()}`,
            type: template.type,
            position: { x: 250, y: 250 },
            data: {
                label: template.label,
                type: template.type,
                config: {},
            },
        }
        addNode(newNode)
    }

    return (
        placeholder = "Search nodes..."
                        value = { searchQuery }
    onChange = {(e) => setSearchQuery(e.target.value)
}
className = "w-full pl-8 pr-3 py-2 text-xs border rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-primary"
    />
                </div >

    {/* Category Filter */ }
    < select
value = { selectedCategory }
onChange = {(e) => setSelectedCategory(e.target.value)}
className = "w-full px-2 py-1.5 text-xs border rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-primary"
    >
{
    categories.map(cat => (
        <option key={cat} value={cat}>{cat}</option>
    ))
}
                </select >
            </div >

            <div className="flex-1 overflow-y-auto p-4 space-y-2">
                {filteredNodes.length === 0 ? (
                    <div className="text-xs text-muted-foreground text-center py-4">
                        No nodes found
                    </div>
                ) : (
                    filteredNodes.map((template) => (
                        <button
                            key={template.type}
                            onClick={() => handleAddNode(template)}
                            className="w-full text-left p-3 rounded-lg border bg-background hover:bg-accent hover:border-primary transition-colors group"
                        >
                            <div className="flex items-start gap-2">
                                <span className="text-xl">{template.icon}</span>
                                <div className="flex-1 min-w-0">
                                    <div className="text-sm font-medium flex items-center gap-1">
                                        {template.label}
                                        <Plus className="h-3 w-3 opacity-0 group-hover:opacity-100 transition-opacity" />
                                    </div>
                                    <div className="text-xs text-muted-foreground mt-0.5 line-clamp-2">
                                        {template.description}
                                    </div>
                                    <div className="text-xs text-primary mt-1">
                                        {template.category}
                                    </div>
                                </div>
                            </div>
                        </button>
                    ))
                )}
            </div>

            <div className="p-4 border-t">
                <div className="text-xs text-muted-foreground">
                    <div className="font-medium mb-2">Quick Tip</div>
                    <p>Click any node to add it to the canvas. Connect nodes by dragging from the bottom handle to the top handle of another node.</p>
                </div>
            </div>
        </div >
    )
}
